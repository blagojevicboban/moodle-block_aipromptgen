{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/.\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * ES6 orchestrator module: aggregates individual feature modules for the AI Prompt Generator block.\n * Split into smaller modules for clarity, testability, and alignment with Moodle JS module guidelines.\n *\n * @module     block_aipromptgen/ui\n * @copyright  2025 AI4Teachers\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {initAgeModal} from 'block_aipromptgen/age';\nimport {attachPicker, attachOutcomesModal, initLanguageModal} from 'block_aipromptgen/pickers';\nimport {attachCopyDownload} from 'block_aipromptgen/actions';\n\n// Unified provider send (OpenAI => submit; Ollama => SSE stream) via hidden field.\nconst initProviderSend = () => {\n    const sendBtn = document.getElementById('ai4t-sendtoai');\n    const select = document.getElementById('ai4t-provider');\n    const gen = document.getElementById('ai4t-generated');\n    // Ensure hidden provider field exists (compat with server resolver).\n    let hidden = document.getElementById('ai4t-sendto');\n    if (!hidden) {\n        const form = document.getElementById('promptform');\n        if (form) {\n            hidden = document.createElement('input');\n            hidden.type = 'hidden';\n            hidden.name = 'sendto';\n            hidden.id = 'ai4t-sendto';\n            form.appendChild(hidden);\n        }\n    }\n    if (!sendBtn || !select || !gen || !hidden) {\n        return;\n    }\n    // Prefer modal body for responses, fall back to inline container.\n    const resp = document.getElementById('ai4t-airesponse-body') || document.getElementById('ai4t-airesponse');\n    const findForm = () => document.getElementById('promptform') || document.getElementById('mform1') || sendBtn.closest('form');\n    const refreshState = () => {\n        const opt = select.options[select.selectedIndex];\n        const unconfigured = opt && /âœ•\\s*$/.test(opt.textContent || '');\n        sendBtn.disabled = (!gen.value.trim() || unconfigured);\n    };\n    const scrollToResponse = () => {\n        const heading = document.getElementById('ai4t-response-heading');\n        if (heading) {\n            try {\n                heading.scrollIntoView({behavior: 'smooth', block: 'start'});\n            } catch (e) {\n                heading.scrollIntoView();\n            }\n        }\n    };\n    const startStream = () => {\n        if (!window.EventSource) { // Fallback: normal submit.\n            const form = findForm();\n            if (form) {\n                form.submit();\n            }\n            return;\n        }\n        const courseInput = document.querySelector('input[name=courseid]');\n        const courseid = courseInput ? courseInput.value : '';\n        hidden.value = 'ollama';\n        // Show response modal/backdrop when streaming starts.\n        const modal = document.getElementById('ai4t-airesponse-modal');\n        const backdrop = document.getElementById('ai4t-modal-backdrop');\n        if (backdrop) { backdrop.style.display = 'block'; }\n        if (modal) { modal.style.display = 'block'; }\n        if (resp) {\n            resp.textContent = '';\n            resp.setAttribute('aria-busy', 'true');\n        }\n        const statusId = 'ai-response-status';\n        let statusEl = document.getElementById(statusId);\n        if (!statusEl) {\n            statusEl = document.createElement('div');\n            statusEl.id = statusId;\n            statusEl.className = 'small text-muted';\n            // Insert status element before the response area when possible.\n            if (resp && resp.parentNode) {\n                resp.parentNode.insertBefore(statusEl, resp);\n            }\n        }\n        if (statusEl) {\n            statusEl.textContent = 'Streaming...';\n        }\n        // Use Moodle root (M.cfg.wwwroot) if available for absolute URL.\n        const root = (window.M && window.M.cfg && M.cfg.wwwroot) ? M.cfg.wwwroot : '';\n        const base = root + '/blocks/aipromptgen/stream.php';\n        let prompt = gen.value || gen.textContent || '';\n        if (!prompt) {\n            // Minimal fallback build.\n            const fd = new FormData(findForm() || undefined);\n            prompt = 'Topic: ' + (fd.get('topic') || '') + '\\n' +\n                     'Lesson: ' + (fd.get('lesson') || '') + '\\n' +\n                     'Outcomes: ' + (fd.get('outcomes') || '');\n        }\n        const es = new EventSource(base + '?courseid=' + encodeURIComponent(courseid) +\n            '&provider=ollama&prompt=' + encodeURIComponent(prompt));\n        let first = true;\n        es.addEventListener('start', () => {\n            if (statusEl) {\n                statusEl.textContent = 'Started';\n            }\n            scrollToResponse();\n        });\n        es.addEventListener('chunk', ev => {\n            if (resp) {\n                resp.textContent += ev.data;\n                if (first) {\n                    scrollToResponse();\n                    first = false;\n                }\n            }\n        });\n        es.addEventListener('error', ev => {\n            if (resp) {\n                resp.textContent += '\\n[Error] ' + (ev.data || '');\n            }\n            if (statusEl) {\n                statusEl.textContent = 'Error';\n            }\n            scrollToResponse();\n        });\n        es.addEventListener('done', () => {\n            if (statusEl) {\n                statusEl.textContent = 'Done';\n            }\n            if (resp) {\n                resp.removeAttribute('aria-busy');\n            }\n            scrollToResponse();\n            es.close();\n        });\n    };\n    select.addEventListener('change', refreshState);\n    gen.addEventListener('input', refreshState);\n    sendBtn.addEventListener('click', e => {\n        if (sendBtn.disabled) {\n            return;\n        }\n        const provider = select.value;\n        if (provider === 'ollama') {\n            e.preventDefault();\n            startStream();\n            return;\n        }\n        hidden.value = provider;\n        const form = findForm();\n        if (form) {\n            form.submit();\n        }\n    });\n    refreshState();\n};\n\nexport const init = () => {\n    // Auto-scroll to generated section if present after postback.\n    const genWrapper = document.getElementById('ai4t-generated-wrapper');\n    if (genWrapper) {\n        try {\n            genWrapper.scrollIntoView({behavior: 'smooth', block: 'start'});\n        } catch (e) {\n            genWrapper.scrollIntoView();\n        }\n    }\n    initAgeModal();\n    attachPicker({\n        openId: 'ai4t-lesson-browse',\n        modalId: 'ai4t-modal',\n        closeId: 'ai4t-modal-close',\n        cancelId: 'ai4t-modal-cancel',\n        itemSelector: '.ai4t-lesson-item',\n        targetId: 'id_lesson'\n    });\n    attachPicker({\n        openId: 'ai4t-topic-browse',\n        modalId: 'ai4t-topic-modal',\n        closeId: 'ai4t-topic-modal-close',\n        cancelId: 'ai4t-topic-modal-cancel',\n        itemSelector: '.ai4t-topic-item',\n        targetId: 'id_topic'\n    });\n    attachOutcomesModal();\n    initLanguageModal();\n    attachPicker({\n        openId: 'ai4t-purpose-browse',\n        modalId: 'ai4t-purpose-modal',\n        closeId: 'ai4t-purpose-modal-close',\n        cancelId: 'ai4t-purpose-modal-cancel',\n        itemSelector: '.ai4t-purpose-item',\n        targetId: 'id_purpose'\n    });\n    attachPicker({\n        openId: 'ai4t-audience-browse',\n        modalId: 'ai4t-audience-modal',\n        closeId: 'ai4t-audience-modal-close',\n        cancelId: 'ai4t-audience-modal-cancel',\n        itemSelector: '.ai4t-audience-item',\n        targetId: 'id_audience'\n    });\n    attachPicker({\n        openId: 'ai4t-classtype-browse',\n        modalId: 'ai4t-classtype-modal',\n        closeId: 'ai4t-classtype-modal-close',\n        cancelId: 'ai4t-classtype-modal-cancel',\n        itemSelector: '.ai4t-classtype-item',\n        targetId: 'id_classtype'\n    });\n    attachCopyDownload();\n    initProviderSend();\n};\n\n"],"names":["initProviderSend","sendBtn","document","getElementById","select","gen","hidden","form","createElement","type","name","id","appendChild","resp","findForm","closest","refreshState","opt","options","selectedIndex","unconfigured","test","textContent","disabled","value","trim","scrollToResponse","heading","scrollIntoView","behavior","block","e","addEventListener","provider","preventDefault","window","EventSource","submit","courseInput","querySelector","courseid","modal","backdrop","style","display","setAttribute","statusEl","className","parentNode","insertBefore","base","M","cfg","wwwroot","prompt","fd","FormData","undefined","get","es","encodeURIComponent","first","ev","data","removeAttribute","close","startStream","genWrapper","openId","modalId","closeId","cancelId","itemSelector","targetId"],"mappings":"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"}