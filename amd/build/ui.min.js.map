{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/.\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * ES6 orchestrator module: aggregates individual feature modules for the AI Prompt Generator block.\n * Split into smaller modules for clarity, testability, and alignment with Moodle JS module guidelines.\n *\n * @module     block_aipromptgen/ui\n * @copyright  2025 AI4Teachers\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {initAgeModal} from 'block_aipromptgen/age';\nimport {attachPicker, attachOutcomesModal, initLanguageModal} from 'block_aipromptgen/pickers';\nimport {attachCopyDownload} from 'block_aipromptgen/actions';\n\n// Unified provider send (OpenAI => submit; Ollama => SSE stream) via hidden field.\n// Helper: set up UI elements for streaming response\nconst setupStreamingUI = (resp) => {\n    const statusId = 'ai-response-status';\n    let statusEl = document.getElementById(statusId);\n    if (!statusEl) {\n        statusEl = document.createElement('div');\n        statusEl.id = statusId;\n        statusEl.className = 'small text-muted';\n        if (resp && resp.parentNode) {\n            resp.parentNode.insertBefore(statusEl, resp);\n        }\n    }\n    if (statusEl) {\n        statusEl.textContent = 'Streaming...';\n    }\n    const modal = document.getElementById('ai4t-airesponse-modal');\n    const backdrop = document.getElementById('ai4t-modal-backdrop');\n    if (backdrop) {\n        backdrop.style.display = 'block';\n    }\n    if (modal) {\n        modal.style.display = 'block';\n    }\n    if (resp) {\n        resp.textContent = '';\n        resp.setAttribute('aria-busy', 'true');\n    }\n    return statusEl;\n};\n\n// Helper: attach event listeners to EventSource\nconst attachStreamListeners = (es, resp, statusEl, scrollToResponse) => {\n    let first = true;\n    es.addEventListener('start', () => {\n        if (statusEl) {\n            statusEl.textContent = 'Started';\n        }\n        scrollToResponse();\n    });\n    es.addEventListener('chunk', (ev) => {\n        if (resp) {\n            resp.textContent += ev.data;\n            if (first) {\n                scrollToResponse();\n                first = false;\n            }\n        }\n    });\n    es.addEventListener('error', (ev) => {\n        if (resp) {\n            resp.textContent += '\\n[Error] ' + (ev.data || '');\n        }\n        if (statusEl) {\n            statusEl.textContent = 'Error';\n        }\n        scrollToResponse();\n    });\n    es.addEventListener('done', () => {\n        if (statusEl) {\n            statusEl.textContent = 'Done';\n        }\n        if (resp) {\n            resp.removeAttribute('aria-busy');\n        }\n        scrollToResponse();\n        es.close();\n    });\n};\n\n// Main streaming implementation\nconst startStreamImpl = (findForm, gen, hidden, resp, scrollToResponse) => {\n    if (!window.EventSource) { // Fallback: normal submit.\n        const form = findForm();\n        if (form) {\n            form.submit();\n        }\n        return;\n    }\n    const courseInput = document.querySelector('input[name=courseid]');\n    const courseid = courseInput ? courseInput.value : '';\n    hidden.value = 'ollama';\n    const statusEl = setupStreamingUI(resp);\n    const root = (window.M && window.M.cfg && M.cfg.wwwroot) ? M.cfg.wwwroot : '';\n    const base = root + '/blocks/aipromptgen/stream.php';\n    let prompt = gen.value || gen.textContent || '';\n    if (!prompt) {\n        const fd = new FormData(findForm() || undefined);\n        prompt = 'Topic: ' + (fd.get('topic') || '') + '\\n' +\n                 'Lesson: ' + (fd.get('lesson') || '') + '\\n' +\n                 'Outcomes: ' + (fd.get('outcomes') || '');\n    }\n    const es = new EventSource(base + '?courseid=' + encodeURIComponent(courseid) +\n        '&provider=ollama&prompt=' + encodeURIComponent(prompt));\n    attachStreamListeners(es, resp, statusEl, scrollToResponse);\n};\n\nconst initProviderSend = () => {\n    const sendBtn = document.getElementById('ai4t-sendtoai');\n    const select = document.getElementById('ai4t-provider');\n    const gen = document.getElementById('ai4t-generated');\n    // Ensure hidden provider field exists (compat with server resolver).\n    let hidden = document.getElementById('ai4t-sendto');\n    if (!hidden) {\n        const form = document.getElementById('promptform');\n        if (form) {\n            hidden = document.createElement('input');\n            hidden.type = 'hidden';\n            hidden.name = 'sendto';\n            hidden.id = 'ai4t-sendto';\n            form.appendChild(hidden);\n        }\n    }\n    if (!sendBtn || !select || !gen || !hidden) {\n        return;\n    }\n    // Prefer modal body for responses, fall back to inline container.\n    const resp = document.getElementById('ai4t-airesponse-body') || document.getElementById('ai4t-airesponse');\n    const findForm = () => document.getElementById('promptform') || document.getElementById('mform1') || sendBtn.closest('form');\n    const refreshState = () => {\n        const opt = select.options[select.selectedIndex];\n        const unconfigured = opt && /âœ•\\s*$/.test(opt.textContent || '');\n        sendBtn.disabled = (!gen.value.trim() || unconfigured);\n    };\n    const scrollToResponse = () => {\n        const heading = document.getElementById('ai4t-response-heading');\n        if (heading) {\n            try {\n                heading.scrollIntoView({behavior: 'smooth', block: 'start'});\n            } catch (e) {\n                heading.scrollIntoView();\n            }\n        }\n    };\n    const startStream = () => startStreamImpl(findForm, gen, hidden, resp, scrollToResponse);\n    select.addEventListener('change', refreshState);\n    gen.addEventListener('input', refreshState);\n    sendBtn.addEventListener('click', e => {\n        if (sendBtn.disabled) {\n            return;\n        }\n        const provider = select.value;\n        if (provider === 'ollama') {\n            e.preventDefault();\n            startStream();\n            return;\n        }\n        hidden.value = provider;\n        const form = findForm();\n        if (form) {\n            form.submit();\n        }\n    });\n    refreshState();\n};\n\nexport const init = () => {\n    // Auto-scroll to generated section if present after postback.\n    const genWrapper = document.getElementById('ai4t-generated-wrapper');\n    if (genWrapper) {\n        try {\n            genWrapper.scrollIntoView({behavior: 'smooth', block: 'start'});\n        } catch (e) {\n            genWrapper.scrollIntoView();\n        }\n    }\n    initAgeModal();\n    attachPicker({\n        openId: 'ai4t-lesson-browse',\n        modalId: 'ai4t-modal',\n        closeId: 'ai4t-modal-close',\n        cancelId: 'ai4t-modal-cancel',\n        itemSelector: '.ai4t-lesson-item',\n        targetId: 'id_lesson'\n    });\n    attachPicker({\n        openId: 'ai4t-topic-browse',\n        modalId: 'ai4t-topic-modal',\n        closeId: 'ai4t-topic-modal-close',\n        cancelId: 'ai4t-topic-modal-cancel',\n        itemSelector: '.ai4t-topic-item',\n        targetId: 'id_topic'\n    });\n    attachOutcomesModal();\n    initLanguageModal();\n    attachPicker({\n        openId: 'ai4t-purpose-browse',\n        modalId: 'ai4t-purpose-modal',\n        closeId: 'ai4t-purpose-modal-close',\n        cancelId: 'ai4t-purpose-modal-cancel',\n        itemSelector: '.ai4t-purpose-item',\n        targetId: 'id_purpose'\n    });\n    attachPicker({\n        openId: 'ai4t-audience-browse',\n        modalId: 'ai4t-audience-modal',\n        closeId: 'ai4t-audience-modal-close',\n        cancelId: 'ai4t-audience-modal-cancel',\n        itemSelector: '.ai4t-audience-item',\n        targetId: 'id_audience'\n    });\n    attachPicker({\n        openId: 'ai4t-classtype-browse',\n        modalId: 'ai4t-classtype-modal',\n        closeId: 'ai4t-classtype-modal-close',\n        cancelId: 'ai4t-classtype-modal-cancel',\n        itemSelector: '.ai4t-classtype-item',\n        targetId: 'id_classtype'\n    });\n    attachCopyDownload();\n    initProviderSend();\n};\n"],"names":["startStreamImpl","findForm","gen","hidden","resp","scrollToResponse","window","EventSource","form","submit","courseInput","document","querySelector","courseid","value","statusEl","getElementById","createElement","id","className","parentNode","insertBefore","textContent","modal","backdrop","style","display","setAttribute","setupStreamingUI","base","M","cfg","wwwroot","prompt","fd","FormData","undefined","get","es","first","addEventListener","ev","data","removeAttribute","close","attachStreamListeners","encodeURIComponent","initProviderSend","sendBtn","select","type","name","appendChild","closest","refreshState","opt","options","selectedIndex","unconfigured","test","disabled","trim","heading","scrollIntoView","behavior","block","e","provider","preventDefault","genWrapper","openId","modalId","closeId","cancelId","itemSelector","targetId"],"mappings":"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"}